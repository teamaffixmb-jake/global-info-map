<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Data Screensaver</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" 
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" 
            crossorigin=""></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #111827;
            color: white;
            overflow: hidden;
        }
        #header {
            background: #1f2937;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #title h1 {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        #title p {
            font-size: 0.875rem;
            color: #9ca3af;
        }
        #controls {
            display: flex;
            gap: 0.5rem;
        }
        button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            background: #374151;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background 0.2s;
        }
        button:hover {
            background: #4b5563;
        }
        button.active-earthquakes {
            background: #2563eb;
        }
        button.active-fires {
            background: #ea580c;
        }
        button.active-iss {
            background: #9333ea;
        }
        #map {
            width: 100%;
            height: calc(100vh - 80px);
        }
        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: none;
        }
        #legend.show {
            display: block;
        }
        #legend h3 {
            margin-bottom: 0.5rem;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem 0;
            font-size: 0.875rem;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }
        .fire-marker {
            background: transparent !important;
            border: none !important;
            font-size: 18px;
            text-align: center;
            line-height: 20px;
        }
        
        /* Pulse animation for SVG circles */
        @keyframes pulse-circle {
            0%, 100% { 
                r: var(--base-radius);
                opacity: 1;
            }
            50% { 
                r: calc(var(--base-radius) * 1.5);
                opacity: 0.7;
            }
        }
        
        /* Bounce animation for fire emoji markers */
        @keyframes bounce-marker {
            0%, 100% { 
                transform: scale(1);
            }
            25% { 
                transform: scale(1.4);
            }
            50% { 
                transform: scale(1.1);
            }
            75% { 
                transform: scale(1.3);
            }
        }
        
        .fire-marker.new-event {
            animation: bounce-marker 1s ease-in-out 3;
            transform-origin: 50% 50%;
        }
    </style>
</head>
<body>
    <div id="header">
        <div id="title">
            <h1>üåç Global Data Screensaver</h1>
            <p id="lastUpdate">Last updated: --:--:--</p>
            <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">
                <span style="color: #fbbf24;">‚óè</span> Earthquakes: <span id="eqCount">0</span> live | 
                <span style="color: #f97316;">üî•</span> Fires: <span id="fireCount">0</span> simulated | 
                <span style="color: #a855f7;">üõ∞Ô∏è</span> ISS: tracking
            </p>
        </div>
    </div>
    <div id="map"></div>
    <div id="loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; font-size: 1.5rem;">
        <div>üåç Loading map...</div>
        <div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">Please wait</div>
    </div>
    <div id="legend">
        <h3 style="margin-bottom: 0.75rem;">Data Legend</h3>
        
        <div style="margin-bottom: 1rem; padding: 0.5rem; background: #374151; border-radius: 0.25rem;">
            <strong style="font-size: 0.875rem; color: #fbbf24;">‚ú® Animation Key</strong>
            <div style="font-size: 0.75rem; margin-top: 0.25rem; color: #d1d5db;">
                üÜï Bouncing = Brand new event!<br>
                üí´ Pulsing = Recent activity
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <strong style="font-size: 0.875rem;">Earthquakes (Magnitude)</strong>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff0000;"></div>
                <span>6.0+ Major</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff6600;"></div>
                <span>5.0-5.9 Moderate</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff9900;"></div>
                <span>4.0-4.9 Light</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffcc00;"></div>
                <span>3.0-3.9 Minor</span>
            </div>
        </div>
        
        <div style="margin-bottom: 1rem;">
            <strong style="font-size: 0.875rem;">Fires</strong>
            <div class="legend-item">
                <div style="color: #f97316; font-size: 1.2rem;">üî•</div>
                <span>Active wildfire</span>
            </div>
        </div>
        
        <div>
            <strong style="font-size: 0.875rem;">Space Station</strong>
            <div class="legend-item">
                <div class="legend-color" style="background: #a855f7; border: 2px solid white;"></div>
                <span>ISS Position</span>
            </div>
        </div>
    </div>

    <script>
        // Sample data generators for when APIs fail or are blocked
        function generateSampleEarthquakes() {
            // Generate realistic earthquake data around the Ring of Fire and other active zones
            const zones = [
                { lat: 35, lon: 140, name: 'Japan' },
                { lat: -15, lon: -72, name: 'Peru' },
                { lat: 37, lon: -122, name: 'California' },
                { lat: -6, lon: 130, name: 'Indonesia' },
                { lat: 19, lon: -155, name: 'Hawaii' },
                { lat: 40, lon: 143, name: 'Japan East' },
                { lat: -38, lon: 176, name: 'New Zealand' },
                { lat: 13, lon: 121, name: 'Philippines' },
                { lat: 61, lon: -150, name: 'Alaska' },
                { lat: -23, lon: -70, name: 'Chile' }
            ];
            
            const earthquakes = [];
            const now = Date.now();
            
            zones.forEach((zone, idx) => {
                const count = Math.floor(Math.random() * 5) + 3;
                for (let i = 0; i < count; i++) {
                    const mag = 2.5 + Math.random() * 4.5;
                    const lat = zone.lat + (Math.random() - 0.5) * 10;
                    const lon = zone.lon + (Math.random() - 0.5) * 10;
                    const time = now - Math.random() * 86400000; // Within last 24 hours
                    
                    earthquakes.push({
                        geometry: { coordinates: [lon, lat] },
                        properties: {
                            mag: parseFloat(mag.toFixed(1)),
                            place: `${Math.floor(Math.random() * 100)}km from ${zone.name}`,
                            time: time
                        }
                    });
                }
            });
            
            return earthquakes;
        }
        
        function generateSampleFires() {
            // Generate fire data in typical fire-prone regions
            const regions = [
                { lat: -10, lon: -55, name: 'Amazon' }, // Amazon
                { lat: -25, lon: 135, name: 'Australia' }, // Australia
                { lat: 37, lon: -120, name: 'California' }, // California
                { lat: 0, lon: 115, name: 'Borneo' }, // Indonesia
                { lat: 10, lon: -85, name: 'Central America' }, // Central America
                { lat: 5, lon: 20, name: 'Central Africa' }, // Africa
                { lat: 55, lon: 95, name: 'Siberia' } // Siberia
            ];
            
            const fires = [];
            regions.forEach(region => {
                const count = Math.floor(Math.random() * 80) + 20;
                for (let i = 0; i < count; i++) {
                    fires.push({
                        lat: region.lat + (Math.random() - 0.5) * 15,
                        lon: region.lon + (Math.random() - 0.5) * 15,
                        brightness: 300 + Math.random() * 100,
                        confidence: Math.random() > 0.7 ? 'high' : 'nominal'
                    });
                }
            });
            
            return fires;
        }
        
        let issOrbitPosition = Math.random() * Math.PI * 2; // Start at random position in orbit
        
        function generateSampleISS() {
            // Simulate ISS orbit (simplified circular orbit)
            issOrbitPosition += 0.004; // Move along orbit
            const inclination = 51.6 * Math.PI / 180; // ISS orbital inclination
            
            return {
                lat: Math.sin(issOrbitPosition) * inclination * 180 / Math.PI,
                lon: ((issOrbitPosition * 180 / Math.PI * 2) % 360) - 180,
                altitude: 420,
                velocity: 27600
            };
        }
        
        // Wait for Leaflet to load
        let map;
        
        function initMap() {
            try {
                // Hide loading message
                document.getElementById('loading').style.display = 'none';
                
                // Initialize map
                map = L.map('map').setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Start loading data after map is initialized
                fetchEarthquakes();
                fetchFires();
                fetchISS();
                updateTimestamp();
                
                // Show legend
                document.getElementById('legend').classList.add('show');
                
                // Auto-refresh every minute
                setInterval(refreshAllData, 60000);
            } catch (error) {
                console.error('Error initializing map:', error);
                document.getElementById('loading').innerHTML = '<div>‚ùå Error loading map</div><div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">Please refresh the page</div>';
            }
        }
        
        // Wait for window to load before initializing
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof L !== 'undefined') {
                    initMap();
                } else {
                    console.error('Leaflet library failed to load');
                    document.getElementById('loading').innerHTML = '<div>‚ùå Failed to load mapping library</div><div style="font-size: 0.875rem; color: #9ca3af; margin-top: 0.5rem;">Check your internet connection and refresh</div>';
                }
            }, 500); // Give extra time for CDN to load
        });

        let earthquakeData = [];
        let fireData = [];
        let issData = null;
        let earthquakeMarkers = [];
        let fireMarkers = [];
        let issMarker = null;
        
        // Track previous data to detect new events
        let previousEarthquakeIds = new Set();
        let previousFireLocations = new Set();
        let previousISSLocation = null;
        let lastUpdateTime = Date.now();

        function clearEarthquakeMarkers() {
            earthquakeMarkers.forEach(marker => {
                if (marker._pulseInterval) {
                    clearInterval(marker._pulseInterval);
                }
                map.removeLayer(marker);
            });
            earthquakeMarkers = [];
        }

        function clearFireMarkers() {
            fireMarkers.forEach(marker => map.removeLayer(marker));
            fireMarkers = [];
        }

        function clearISSMarker() {
            if (issMarker) {
                if (issMarker._pulseInterval) {
                    clearInterval(issMarker._pulseInterval);
                }
                map.removeLayer(issMarker);
                issMarker = null;
            }
        }

        function formatAge(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            
            if (minutes < 1) return 'Just now!';
            if (minutes < 60) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            if (hours < 24) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            const days = Math.floor(hours / 24);
            return `${days} day${days > 1 ? 's' : ''} ago`;
        }

        function getMagnitudeColor(mag) {
            if (mag >= 6) return '#ff0000';
            if (mag >= 5) return '#ff6600';
            if (mag >= 4) return '#ff9900';
            if (mag >= 3) return '#ffcc00';
            return '#ffff00';
        }

        function getMagnitudeRadius(mag) {
            return Math.max(3, mag * 3);
        }

        async function fetchEarthquakes() {
            try {
                // USGS API supports CORS
                const response = await fetch('https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                earthquakeData = data.features;
                document.getElementById('eqCount').textContent = earthquakeData.length;
                displayEarthquakes();
            } catch (error) {
                console.error('Error fetching earthquakes:', error);
                // Use sample data as fallback
                earthquakeData = generateSampleEarthquakes();
                document.getElementById('eqCount').textContent = earthquakeData.length + ' (sample)';
                displayEarthquakes();
            }
        }

        function displayEarthquakes() {
            clearEarthquakeMarkers();
            const currentEarthquakeIds = new Set();
            const now = Date.now();
            
            earthquakeData.forEach(eq => {
                const [lon, lat] = eq.geometry.coordinates;
                const mag = eq.properties.mag;
                const place = eq.properties.place;
                const time = new Date(eq.properties.time).toLocaleString();
                const eventTime = eq.properties.time;
                const eventId = eq.id || `${lat}-${lon}-${mag}-${eventTime}`;
                
                currentEarthquakeIds.add(eventId);
                const isNew = !previousEarthquakeIds.has(eventId);
                const timeSinceEvent = now - eventTime;
                const isVeryRecent = timeSinceEvent < 600000; // Less than 10 minutes old
                const isRecent = timeSinceEvent < 3600000; // Less than 1 hour old
                
                const baseRadius = getMagnitudeRadius(mag);

                const circle = L.circleMarker([lat, lon], {
                    radius: baseRadius,
                    fillColor: getMagnitudeColor(mag),
                    color: '#fff',
                    weight: isNew ? 3 : 1,
                    opacity: isNew ? 1 : 0.8,
                    fillOpacity: isNew ? 0.9 : 0.6
                }).addTo(map);

                const ageText = isVeryRecent ? ' üÜï VERY RECENT!' : (isRecent ? ' ‚è∞ Recent' : '');
                circle.bindPopup(`
                    <strong>üåç Earthquake - Magnitude: ${mag}${ageText}</strong><br>
                    Location: ${place}<br>
                    Time: ${time}<br>
                    Age: ${formatAge(timeSinceEvent)}
                `);
                
                // Animate new earthquakes with radius pulsing
                if (isNew && previousEarthquakeIds.size > 0) {
                    circle.openPopup();
                    animateCircleBounce(circle, baseRadius);
                } else if (isVeryRecent) {
                    animateCirclePulse(circle, baseRadius);
                }

                earthquakeMarkers.push(circle);
            });
            
            previousEarthquakeIds = currentEarthquakeIds;
        }
        
        function animateCircleBounce(circle, baseRadius) {
            const bounces = [
                {radius: baseRadius * 1.5, duration: 250},
                {radius: baseRadius, duration: 250},
                {radius: baseRadius * 1.3, duration: 200},
                {radius: baseRadius, duration: 200},
                {radius: baseRadius * 1.4, duration: 200},
                {radius: baseRadius, duration: 200}
            ];
            
            let index = 0;
            function nextBounce() {
                if (index < bounces.length) {
                    circle.setRadius(bounces[index].radius);
                    setTimeout(nextBounce, bounces[index].duration);
                    index++;
                }
            }
            nextBounce();
        }
        
        function animateCirclePulse(circle, baseRadius) {
            let growing = true;
            let currentRadius = baseRadius;
            
            const pulseInterval = setInterval(() => {
                if (growing) {
                    currentRadius += 0.3;
                    if (currentRadius >= baseRadius * 1.3) growing = false;
                } else {
                    currentRadius -= 0.3;
                    if (currentRadius <= baseRadius) growing = true;
                }
                circle.setRadius(currentRadius);
            }, 100);
            
            // Store interval so we can clear it when markers are cleared
            circle._pulseInterval = pulseInterval;
        }

        async function fetchFires() {
            try {
                // NASA FIRMS often blocks CORS, so we'll use sample data
                // In a real deployment, you'd need a backend proxy
                fireData = generateSampleFires();
                document.getElementById('fireCount').textContent = fireData.length;
                displayFires();
            } catch (error) {
                console.error('Error fetching fires:', error);
                fireData = generateSampleFires();
                document.getElementById('fireCount').textContent = fireData.length;
                displayFires();
            }
        }

        function displayFires() {
            clearFireMarkers();
            console.log('Displaying', fireData.length, 'fires');
            const currentFireLocations = new Set();
            
            // Create custom fire icon
            const fireIcon = L.divIcon({
                html: 'üî•',
                className: 'fire-marker',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            const newFireIcon = L.divIcon({
                html: 'üî•',
                className: 'fire-marker new-event',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            fireData.slice(0, 500).forEach((fire, idx) => {
                const locationKey = `${fire.lat.toFixed(1)}-${fire.lon.toFixed(1)}`;
                currentFireLocations.add(locationKey);
                const isNew = !previousFireLocations.has(locationKey);
                
                const marker = L.marker([fire.lat, fire.lon], {
                    icon: isNew ? newFireIcon : fireIcon
                }).addTo(map);

                marker.bindPopup(`
                    <strong>üî• Active Wildfire${isNew ? ' üÜï NEW!' : ''}</strong><br>
                    Location: ${fire.lat.toFixed(2)}¬∞, ${fire.lon.toFixed(2)}¬∞<br>
                    Brightness: ${fire.brightness.toFixed(0)}K<br>
                    Confidence: ${fire.confidence}
                `);
                
                // Auto-open popup for new fires
                if (isNew && previousFireLocations.size > 0) {
                    marker.openPopup();
                }

                fireMarkers.push(marker);
            });
            
            previousFireLocations = currentFireLocations;
        }

        async function fetchISS() {
            try {
                // Use CORS-friendly ISS API
                const response = await fetch('https://api.wheretheiss.at/v1/satellites/25544', {
                    method: 'GET',
                    mode: 'cors'
                });
                const data = await response.json();
                issData = {
                    lat: data.latitude,
                    lon: data.longitude,
                    altitude: data.altitude,
                    velocity: data.velocity
                };
                displayISS();
            } catch (error) {
                console.error('Error fetching ISS:', error);
                // Generate moving ISS position as fallback
                issData = generateSampleISS();
                displayISS();
            }
        }

        function displayISS() {
            clearISSMarker();
            if (issData) {
                const hasMoved = previousISSLocation && 
                    (Math.abs(previousISSLocation.lat - issData.lat) > 0.5 || 
                     Math.abs(previousISSLocation.lon - issData.lon) > 0.5);
                
                const baseRadius = 12;
                issMarker = L.circleMarker([issData.lat, issData.lon], {
                    radius: baseRadius,
                    fillColor: '#a855f7',
                    color: '#ffffff',
                    weight: hasMoved ? 4 : 3,
                    opacity: 1,
                    fillOpacity: hasMoved ? 1 : 0.9
                }).addTo(map);

                issMarker.bindPopup(`
                    <strong>üõ∞Ô∏è International Space Station${hasMoved ? ' üÜï MOVED!' : ''}</strong><br>
                    Latitude: ${issData.lat.toFixed(2)}¬∞<br>
                    Longitude: ${issData.lon.toFixed(2)}¬∞<br>
                    Altitude: ${issData.altitude.toFixed(0)} km<br>
                    Speed: ${issData.velocity.toFixed(0)} km/h<br>
                    Status: Orbiting Earth üåç
                `);
                
                // Animate if moved
                if (hasMoved) {
                    animateCircleBounce(issMarker, baseRadius);
                } else {
                    // Always pulse the ISS since it's constantly moving
                    animateCirclePulse(issMarker, baseRadius);
                }
                
                previousISSLocation = {lat: issData.lat, lon: issData.lon};
            } else {
                console.error('No ISS data available');
            }
        }

        function refreshAllData() {
            fetchEarthquakes();
            fetchFires();
            fetchISS();
            updateTimestamp();
        }

        function updateTimestamp() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = 'Last updated: ' + now.toLocaleTimeString();
        }

    </script>
</body>
</html>
